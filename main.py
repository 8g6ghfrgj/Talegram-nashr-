import os
import logging
import threading
import asyncio
from http.server import HTTPServer
from http.server import BaseHTTPRequestHandler

from telegram.ext import Application, CommandHandler, CallbackQueryHandler, ConversationHandler, MessageHandler, filters
from telegram import Update

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ù…Ù† Ø§Ù„Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
from config import BOT_TOKEN, OWNER_ID
from database.database import BotDatabase
from managers.telegram_manager import TelegramBotManager
from handlers.admin_handlers import AdminHandlers
from handlers.account_handlers import AccountHandlers
from handlers.ad_handlers import AdHandlers
from handlers.group_handlers import GroupHandlers
from handlers.reply_handlers import ReplyHandlers
from handlers.conversation_handlers import ConversationHandlers
from config import (
    ADD_ACCOUNT, ADD_AD_TYPE, ADD_AD_TEXT, ADD_AD_MEDIA,
    ADD_GROUP, ADD_PRIVATE_REPLY, ADD_ADMIN,
    ADD_RANDOM_REPLY, ADD_PRIVATE_TEXT, ADD_GROUP_TEXT,
    ADD_GROUP_PHOTO
)

# Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³Ø¬Ù„
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# Ø®Ø§Ø¯Ù… HTTP Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©
class HealthCheckHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b'Bot is running!')
    
    def log_message(self, *args):
        pass

def run_health_server():
    """ØªØ´ØºÙŠÙ„ Ø®Ø§Ø¯Ù… HTTP Ù„Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ­Ø©"""
    port = int(os.environ.get("PORT", 8080))
    server = HTTPServer(('0.0.0.0', port), HealthCheckHandler)
    print(f"âœ… Health server running on port {port}")
    server.serve_forever()

class MainBot:
    def __init__(self):
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙƒÙ†
        if not BOT_TOKEN:
            print("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… ØªØ¹ÙŠÙŠÙ† BOT_TOKEN ÙÙŠ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©")
            print("âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© BOT_TOKEN ÙÙŠ Render.com â†’ Environment")
            exit(1)
        
        # ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        self.db = BotDatabase()
        
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
        self.manager = TelegramBotManager(self.db)
        
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
        self.admin_handlers = AdminHandlers(self.db, self.manager)
        self.account_handlers = AccountHandlers(self.db, self.manager)
        self.ad_handlers = AdHandlers(self.db, self.manager)
        self.group_handlers = GroupHandlers(self.db, self.manager)
        self.reply_handlers = ReplyHandlers(self.db, self.manager)
        self.conversation_handlers = ConversationHandlers(
            self.db, self.manager, self.admin_handlers,
            self.account_handlers, self.ad_handlers,
            self.group_handlers, self.reply_handlers
        )
        
        # ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        self.application = Application.builder().token(BOT_TOKEN).build()
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª
        self.setup_handlers()
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
        self._add_owner()
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        self._create_directories()
        
        # Ù…ØªØºÙŠØ± Ù„Ø­ÙØ¸ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        self.user_conversations = {}
    
    def _add_owner(self):
        """Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        try:
            success, message = self.db.add_admin(OWNER_ID, "@owner", "Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ", True)
            if success:
                logger.info(f"âœ… {message}")
            else:
                logger.info(f"âš ï¸ {message}")
        except Exception as e:
            logger.error(f"Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø§Ù„Ùƒ: {e}")
    
    def _create_directories(self):
        """Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"""
        directories = ["temp_files/ads", "temp_files/group_replies", "temp_files/random_replies"]
        for directory in directories:
            os.makedirs(directory, exist_ok=True)
            logger.info(f"âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù„Ø¯: {directory}")
    
    def get_user_context(self, user_id):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø³ÙŠØ§Ù‚ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…"""
        if user_id not in self.user_conversations:
            self.user_conversations[user_id] = {}
        return self.user_conversations[user_id]
    
    async def start(self, update: Update, context):
        """Ø¨Ø¯Ø¡ Ø§Ù„Ø¨ÙˆØª"""
        user = update.effective_user
        user_id = user.id
        
        if not self.db.is_admin(user_id):
            await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
            return
        
        user_context = self.get_user_context(user_id)
        user_context['conversation_active'] = False
        
        keyboard = [
            [InlineKeyboardButton("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª", callback_data="manage_accounts")],
            [InlineKeyboardButton("ğŸ“¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª", callback_data="manage_ads")],
            [InlineKeyboardButton("ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª", callback_data="manage_groups")],
            [InlineKeyboardButton("ğŸ’¬ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø±Ø¯ÙˆØ¯", callback_data="manage_replies")],
            [InlineKeyboardButton("ğŸ‘¨â€ğŸ’¼ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†", callback_data="manage_admins")],
            [InlineKeyboardButton("ğŸš€ Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø±", callback_data="start_publishing")],
            [InlineKeyboardButton("â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù†Ø´Ø±", callback_data="stop_publishing")]
        ]
        
        from telegram import InlineKeyboardMarkup
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await update.message.reply_text(
            "ğŸš€ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„ÙØ¹Ù„ÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„\n\n"
            "âš¡ Ø§Ù„Ù†Ø´Ø± Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø© Ù…Ø¹ ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª\n"
            "âš¡ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©\n"
            "âš¡ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ø£Ù‚ØµÙ‰ Ø³Ø±Ø¹Ø©\n\n"
            "Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ ØªÙ†ÙÙŠØ°Ù‡:",
            reply_markup=reply_markup,
            parse_mode='Markdown'
        )
    
    async def cancel(self, update: Update, context):
        """Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"""
        user_id = update.message.from_user.id
        if not self.db.is_admin(user_id):
            await update.message.reply_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
            return
        
        user_context = self.get_user_context(user_id)
        user_context['conversation_active'] = False
        
        await update.message.reply_text("âŒ ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø£Ù…Ø±.")
        await self.start(update, context)
        return ConversationHandler.END
    
    async def handle_callback(self, update: Update, context):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø±"""
        query = update.callback_query
        await query.answer()
        
        user_id = query.from_user.id
        if not self.db.is_admin(user_id):
            await query.edit_message_text("âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¨ÙˆØª.")
            return
        
        data = query.data
        
        # ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©
        if data == "manage_accounts":
            await self.account_handlers.manage_accounts(query, context)
        elif data == "manage_ads":
            await self.ad_handlers.manage_ads(query, context)
        elif data == "manage_groups":
            await self.group_handlers.manage_groups(query, context)
        elif data == "manage_replies":
            await self.reply_handlers.manage_replies(query, context)
        elif data == "manage_admins":
            await self.admin_handlers.manage_admins(query, context)
        elif data == "start_publishing":
            await self.manager.start_publishing(query, context)
        elif data == "stop_publishing":
            await self.manager.stop_publishing(query, context)
        elif data in ["back_to_main", "back_to_accounts", "back_to_ads", 
                     "back_to_groups", "back_to_replies", "back_to_admins",
                     "back_to_private_replies", "back_to_group_replies"]:
            await self.conversation_handlers.handle_back_buttons(query, context, data)
        else:
            # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø®Ø±Ù‰ Ø¹Ø¨Ø± conversation_handlers
            await self.conversation_handlers.handle_callback(query, context)
    
    def setup_handlers(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø¨ÙˆØª"""
        # Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        self.application.add_handler(CommandHandler("start", self.start))
        self.application.add_handler(CommandHandler("cancel", self.cancel))
        
        # Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©
        self.conversation_handlers.setup_conversation_handlers(self.application)
        
        # Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        self.application.add_handler(CallbackQueryHandler(self.handle_callback))
        
        # Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (Ù„Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙˆØ§Ù…Ø± ÙÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª)
        self.application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, self.handle_message))
    
    async def handle_message(self, update: Update, context):
        """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ù†ØµÙŠØ© Ø§Ù„Ø¹Ø§Ù…Ø©"""
        # Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØªØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªÙŠ Ù„Ø§ ØªÙƒÙˆÙ† Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ù…Ø­Ø§Ø¯Ø«Ø©
        pass
    
    def run(self):
        """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
        print("=" * 60)
        print("ğŸš€ Ø¨ÙˆØª Ø§Ù„Ù†Ø´Ø± Ø§Ù„ÙØ¹Ù„ÙŠ - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø¹Ø¯Ù„")
        print("=" * 60)
        print("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ£Ø®ÙŠØ±Ø§Øª Ø­Ø³Ø¨ Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ§Øª ØªÙ„ÙŠØ¬Ø±Ø§Ù…:")
        print("   â±ï¸  ØªØ£Ø®ÙŠØ± Ù†Ø´Ø± Ø§Ù„Ù‚Ø±ÙˆØ¨Ø§Øª: 60 Ø«Ø§Ù†ÙŠØ©")
        print("   âš¡ Ø§Ù„Ø³Ø±Ø¹Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰: ÙƒÙ…Ø§ Ù‡ÙŠ")
        print(f"   ğŸ‘‘ Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„ÙˆØ­ÙŠØ¯: Ø§Ù„Ø¢ÙŠØ¯ÙŠ {OWNER_ID}")
        print("   ğŸ“ Ø§Ø³Ù… Ù…Ù„Ù Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„: ØªØ³ÙˆÙŠ Ø³ÙƒÙ„ÙŠÙ ØµØ­ØªÙŠ ÙˆØ§ØªØ³Ø§Ø¨.vcf")
        print("=" * 60)
        print("ğŸ“Š Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„ Ø§Ù„Ø¢Ù†! Ø§Ø¶ØºØ· Ctrl+C Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù")
        print("=" * 60)
        
        # Ø¨Ø¯Ø¡ Ø®Ø§Ø¯Ù… HTTP ÙÙŠ Ø®ÙŠØ· Ù…Ù†ÙØµÙ„
        http_thread = threading.Thread(target=run_health_server, daemon=True)
        http_thread.start()
        
        # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
        try:
            self.application.run_polling(allowed_updates=Update.ALL_TYPES)
        except KeyboardInterrupt:
            print("\n\nğŸ›‘ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙˆØª...")
            # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
            asyncio.run(self.manager.cleanup_all())
        except Exception as e:
            logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
            raise

if __name__ == "__main__":
    try:
        bot = MainBot()
        bot.run()
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª: {e}")
        print(f"âŒ Ø®Ø·Ø£: {e}")
        print("ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...")
        # ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ© Ù‡Ù†Ø§ Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±
